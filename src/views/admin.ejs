<%- include('layout', { body: ` 
<!-- Header -->
<section class="bg-gray-800 text-white py-8">
    <div class="max-w-6xl mx-auto px-4">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
    </div>
</section>

<section class="py-8" x-data="adminDashboard()">
    <div class="max-w-6xl mx-auto px-4">
        ${typeof error !== 'undefined' && error ? `
        <div class="bg-red-100 text-red-700 p-4 rounded-lg mb-8">
            ${error}
        </div>
        ` : ''}
        
        <!-- Stats Overview -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-3xl font-bold text-bitcoin">${typeof users !== 'undefined' ? users.length : 0}</div>
                <div class="text-gray-600">Registered Users</div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-3xl font-bold text-bitcoin">${typeof tickets !== 'undefined' ? tickets.length : 0}</div>
                <div class="text-gray-600">Total Tickets</div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-3xl font-bold text-yellow-500">${typeof pendingTickets !== 'undefined' ? pendingTickets.length : 0}</div>
                <div class="text-gray-600">Pending Validation</div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="text-3xl font-bold text-green-500">${typeof raffles !== 'undefined' ? raffles.length : 0}</div>
                <div class="text-gray-600">Raffles Run</div>
            </div>
        </div>
        
        <!-- Lightning Node Status -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-8" x-data="{ lnd: null, loading: true }" x-init="
            fetch('/api/admin/lightning/status', { headers: { 'X-Admin-Password': password } })
                .then(r => r.json())
                .then(d => { lnd = d.lightning; loading = false; })
                .catch(() => { lnd = { configured: false, reason: 'Failed to connect' }; loading = false; })
        ">
            <h2 class="text-xl font-bold mb-4">‚ö° Lightning Node</h2>
            <template x-if="loading"><div class="text-gray-500">Checking node status...</div></template>
            <template x-if="!loading && lnd && !lnd.configured">
                <div class="text-yellow-600">
                    <span class="font-bold">Not Connected</span> ‚Äî <span x-text="lnd.reason"></span>
                </div>
            </template>
            <template x-if="!loading && lnd && lnd.configured">
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <div class="text-sm text-gray-500">Node Alias</div>
                        <div class="font-bold" x-text="lnd.alias"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Channel Balance</div>
                        <div class="font-bold" x-text="lnd.channelBalance && !lnd.channelBalance.error ? lnd.channelBalance.localBalance.toLocaleString() + ' sats' : 'N/A'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Auto-Pay</div>
                        <div class="font-bold" :class="lnd.autoPayEnabled ? 'text-green-500' : 'text-yellow-500'" x-text="lnd.autoPayEnabled ? 'Enabled' : 'Disabled'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Default Prize</div>
                        <div class="font-bold" x-text="lnd.defaultPrizeSats ? lnd.defaultPrizeSats.toLocaleString() + ' sats' : 'Not set'"></div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Blockchain Info -->
        ${typeof raffleInfo !== 'undefined' && raffleInfo ? `
        <div class="bg-white rounded-lg p-6 shadow-sm mb-8">
            <h2 class="text-xl font-bold mb-4">Current Raffle Period</h2>
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <div class="text-sm text-gray-500">Current Block</div>
                    <div class="font-bold">#${raffleInfo.currentHeight.toLocaleString()}</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Next Raffle Block</div>
                    <div class="font-bold">#${raffleInfo.nextRaffleBlock.toLocaleString()}</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Blocks Away</div>
                    <div class="font-bold">${raffleInfo.blocksUntilNext.toLocaleString()}</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Estimated Time</div>
                    <div class="font-bold">${raffleInfo.timeEstimate}</div>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- Unpaid Raffle Alert -->
        ${typeof raffles !== 'undefined' && raffles.length > 0 && raffles.find(function(r) { return !r.paid_at; }) ? (function() {
            var unpaid = raffles.find(function(r) { return !r.paid_at; });
            return '<div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-8">' +
                '<div class="flex flex-wrap items-start justify-between gap-4">' +
                    '<div>' +
                        '<h2 class="text-xl font-bold text-yellow-800 mb-1">‚ö° Raffle Winner ‚Äî Payment Needed</h2>' +
                        '<p class="text-yellow-700 text-sm mb-3">Block #' + unpaid.block_height.toLocaleString() + ' raffle has been committed. The winner is determined ‚Äî ' + (unpaid.claim_token ? 'claim link sent via email.' : 'payment is pending.') + '</p>' +
                        '<div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">' +
                            '<div><span class="text-yellow-600">Winner:</span> <strong>' + (unpaid.email || 'Anonymous') + '</strong></div>' +
                            '<div><span class="text-yellow-600">LN Address:</span> <strong>' + (unpaid.lnurl_address || 'None') + '</strong></div>' +
                            '<div><span class="text-yellow-600">Entries:</span> <strong>' + unpaid.total_tickets + '</strong></div>' +
                            '<div><span class="text-yellow-600">Prize:</span> <strong>' + (unpaid.prize_amount_sats ? unpaid.prize_amount_sats.toLocaleString() + ' sats' : 'Not set') + '</strong></div>' +
                        '</div>' +
                        '<div class="mt-3 bg-yellow-100 rounded-lg p-2 text-xs font-mono text-yellow-800 break-all">' +
                            'Hash: ' + unpaid.block_hash + '<br>' +
                            'int(hash) mod ' + unpaid.total_tickets + ' = ' + unpaid.winning_index +
                        '</div>' +
                    '</div>' +
                    '<div class="flex flex-col gap-2">' +
                        (unpaid.lnurl_address ? '<button onclick="payUnpaidRaffle(' + unpaid.id + ', ' + (unpaid.prize_amount_sats || 0) + ')" class="bg-yellow-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-yellow-600 transition whitespace-nowrap">‚ö° Pay Winner Now</button>' : '') +
                        '<button onclick="markUnpaidRafflePaid(' + unpaid.id + ')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition whitespace-nowrap">Mark as Paid Manually</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        })() : ''}

        <!-- Settings Panel -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-8" x-data="settingsPanel('${typeof password !== 'undefined' ? password : ''}')">
            <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Settings</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Review Approval</label>
                    <select x-model="reviewMode" @change="saveSettings()" class="w-full px-4 py-2 border rounded-lg">
                        <option value="manual_review">Manual Review (admin approves each ticket)</option>
                        <option value="auto_approve">Auto-Approve (all submissions auto-validated)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1" x-text="reviewMode === 'auto_approve' ? 'All new submissions will be auto-approved.' : 'New submissions require admin approval.'"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Accepted Review Links</label>
                    <select x-model="reviewLinkMode" @change="saveSettings()" class="w-full px-4 py-2 border rounded-lg">
                        <option value="google">Google Only (Google Maps / Google Reviews)</option>
                        <option value="all">All Major Platforms (Google, Yelp, TripAdvisor, Trustpilot, etc.)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1" x-text="reviewLinkMode === 'google' ? 'Only Google Maps links accepted.' : 'Accepts links from Google, Yelp, TripAdvisor, Trustpilot, Facebook, Apple Maps, and more. Trap/unknown sites are still blocked.'"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Auto-Pay Winner</label>
                    <select x-model="autoPayMode" @change="saveSettings()" class="w-full px-4 py-2 border rounded-lg">
                        <option value="false">Manual Payment (admin pays via dashboard)</option>
                        <option value="true">Auto-Pay (Lightning payment sent automatically)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1" x-text="autoPayMode === 'true' ? 'Winner will be paid automatically via Lightning when the raffle block is mined.' : 'Raffle result is committed automatically, but you must pay the winner manually.'"></p>
                    <p class="text-xs text-gray-400 mt-1">Note: The raffle result is <strong>always</strong> determined automatically by the trigger block hash. This setting only controls whether payment is also automatic.</p>
                </div>
            </div>
            <div x-show="settingsMsg" x-cloak class="mt-3 text-sm text-green-600" x-text="settingsMsg"></div>
        </div>
        
        <!-- Telegram Setup -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-8" x-data="telegramPanel('${typeof password !== 'undefined' ? password : ''}')">
            <h2 class="text-xl font-bold mb-1">üì± Telegram Notifications</h2>
            <p class="text-sm text-gray-500 mb-4">Admin Telegram chat IDs receive new review alerts and raffle notifications.</p>
            
            <!-- Current chats -->
            <div class="mb-4">
                <div class="text-sm font-medium text-gray-700 mb-2">Active admin chats:</div>
                <template x-if="chatsLoading"><div class="text-gray-400 text-sm">Loading...</div></template>
                <template x-if="!chatsLoading && allChats.length === 0">
                    <div class="text-yellow-600 text-sm">‚ö†Ô∏è No Telegram chat IDs configured yet.</div>
                </template>
                <div class="space-y-2">
                    <template x-for="chat in allChats" :key="chat">
                        <div class="flex items-center justify-between bg-gray-50 rounded px-3 py-2 text-sm">
                            <span class="font-mono" x-text="chat + (chat === primaryChat ? ' (primary)' : '')"></span>
                            <button x-show="chat !== primaryChat" @click="removeChat(chat)"
                                class="text-red-500 hover:text-red-700 text-xs">Remove</button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Invite a new admin ‚Äî one click -->
            <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
                <div class="text-sm font-medium text-gray-700 mb-2">üîó Invite a new admin</div>
                <p class="text-xs text-gray-500 mb-2">One click ‚Üí Telegram opens ‚Üí they tap Start ‚Üí auto-registered. No chat ID needed.</p>
                <a href="/api/admin/telegram/invite?password=${typeof password !== 'undefined' ? password : ''}" target="_blank"
                    class="inline-flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600">
                    üì≤ Add New Admin via Telegram
                </a>
            </div>

            <!-- Add chat ID manually -->
            <div class="flex gap-2">
                <input 
                    type="text" 
                    x-model="newChatId"
                    placeholder="Or enter chat ID manually (e.g. 123456789)"
                    class="flex-1 px-3 py-2 border rounded-lg text-sm"
                    @keydown.enter="addChat()"
                >
                <button @click="addChat()" :disabled="telegramLoading"
                    class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 disabled:opacity-50 whitespace-nowrap">
                    Add &amp; Test
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-1">
                Don't know your chat ID? Message <a href="https://t.me/userinfobot" target="_blank" class="text-blue-500 underline">@userinfobot</a> on Telegram ‚Äî it replies with your numeric ID.
                <br>New admin? <a href="https://t.me/CoraTelegramBot" target="_blank" class="text-blue-500 underline">Start @CoraTelegramBot</a> first so it can message you.
            </p>
            <div x-show="telegramMsg" x-cloak class="mt-2 text-sm" :class="telegramOk ? 'text-green-600' : 'text-red-600'" x-text="telegramMsg"></div>
        </div>

        <!-- Test Raffle (Live ‚Äî sends 100 sats) -->
        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-8" x-data="{ testResult: null, testLoading: false, testSuccess: false }">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
                <div>
                    <h2 class="text-xl font-bold text-blue-800">üß™ Test Raffle</h2>
                    <p class="text-blue-600 text-sm mt-1">Picks a winner from all approved tickets, <strong>sends 100 sats via Lightning</strong>, and creates a real raffle record visible in the public history. Use üóëÔ∏è Delete in the Raffles tab to clean up afterwards.</p>
                </div>
                <button 
                    @click="if(!confirm('This will send 100 sats to the winner and create a raffle record. Continue?')) return; testLoading = true; testResult = null; fetch('/api/admin/raffle/test', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password } }).then(r => r.json()).then(d => { testResult = d; testSuccess = d.success; testLoading = false; if(d.success) setTimeout(() => location.reload(), 3000); }).catch(e => { testResult = { error: e.message }; testSuccess = false; testLoading = false; })"
                    :disabled="testLoading"
                    class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 disabled:opacity-50 transition whitespace-nowrap"
                >
                    <span x-text="testLoading ? '‚è≥ Sending 100 sats...' : '‚ö° Test Raffle ‚Äî Send 100 sats'"></span>
                </button>
            </div>
            <div x-show="testResult" x-cloak class="mt-4 p-4 rounded-lg" :class="testSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-700'">
                <template x-if="testSuccess && testResult.raffle">
                    <div>
                        <div class="font-bold text-lg mb-2">üé∞ Test Raffle ‚Äî LIVE RESULT</div>
                        <div class="text-sm mb-3 font-medium" x-text="testResult.message"></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm mb-3">
                            <div><span class="text-green-600">Block:</span> <strong x-text="'#' + testResult.raffle.blockHeight.toLocaleString()"></strong></div>
                            <div><span class="text-green-600">Entries:</span> <strong x-text="testResult.raffle.totalTickets"></strong></div>
                            <div><span class="text-green-600">Winner Index:</span> <strong x-text="testResult.raffle.winnerIndex"></strong></div>
                            <div><span class="text-green-600">Winner:</span> <strong x-text="testResult.raffle.winner.email"></strong></div>
                            <div><span class="text-green-600">LN Address:</span> <strong x-text="testResult.raffle.winner.lnurl"></strong></div>
                            <div><span class="text-green-600">Merchant:</span> <strong x-text="testResult.raffle.winner.merchantName"></strong></div>
                        </div>
                        <div class="bg-green-200 rounded-lg p-2 text-xs font-mono text-green-900 break-all" x-text="testResult.raffle.formula"></div>
                        <div class="mt-2 text-xs text-green-600 font-medium" x-text="testResult.raffle.note"></div>
                        <div class="mt-2 text-xs text-gray-500">Page will reload in 3 seconds...</div>
                    </div>
                </template>
                <template x-if="!testSuccess">
                    <div x-text="testResult.error || 'Unknown error'"></div>
                </template>
            </div>
        </div>

        <!-- Run Raffle -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-8">
            <h2 class="text-xl font-bold mb-4">Run Raffle</h2>
            <form @submit.prevent="runRaffle" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Block Height</label>
                    <input 
                        type="number" 
                        x-model="raffleBlockHeight"
                        class="px-4 py-2 border rounded-lg"
                        placeholder="e.g., 880992"
                    >
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Prize (sats)</label>
                    <input 
                        type="number" 
                        x-model="prizeAmount"
                        class="px-4 py-2 border rounded-lg"
                        placeholder="e.g., 100000"
                    >
                </div>
                <button 
                    type="submit"
                    :disabled="raffleLoading"
                    class="bg-green-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-600 disabled:opacity-50"
                >
                    Run Raffle
                </button>
            </form>
            <div x-show="raffleResult" x-cloak class="mt-4 p-4 rounded-lg" :class="raffleSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                <pre x-text="JSON.stringify(raffleResult, null, 2)" class="text-sm overflow-auto"></pre>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="border-b flex">
                <button 
                    @click="activeTab = 'tickets'"
                    :class="activeTab === 'tickets' ? 'bg-bitcoin text-white' : 'text-gray-600 hover:bg-gray-100'"
                    class="px-6 py-3 font-medium"
                >
                    Tickets
                </button>
                <button 
                    @click="activeTab = 'users'"
                    :class="activeTab === 'users' ? 'bg-bitcoin text-white' : 'text-gray-600 hover:bg-gray-100'"
                    class="px-6 py-3 font-medium"
                >
                    Users
                </button>
                <button 
                    @click="activeTab = 'raffles'"
                    :class="activeTab === 'raffles' ? 'bg-bitcoin text-white' : 'text-gray-600 hover:bg-gray-100'"
                    class="px-6 py-3 font-medium"
                >
                    Raffles
                </button>
            </div>
            
            <!-- Tickets Tab -->
            <div x-show="activeTab === 'tickets'" class="p-6">
                <h3 class="font-bold mb-4">Recent Tickets</h3>
                <div class="space-y-2">
                    ${typeof tickets !== 'undefined' && tickets.length > 0 ? 
                        tickets.slice(0, 50).map(t => `
                        <div class="border rounded-lg" x-data="{ open: false, aiResult: null, aiLoading: false }">
                            <div class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-50" @click="open = !open">
                                <div class="flex items-center gap-4 text-sm">
                                    <span class="font-mono text-gray-400">#${t.id}</span>
                                    <span>${t.email || 'Anonymous'}</span>
                                    <span class="text-gray-500">${t.merchant_name || '-'}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    ${t.is_valid ? 
                                        '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-medium">Approved</span>' : 
                                        (t.validation_reason ? '<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-medium">Rejected</span>' : '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-xs font-medium">Pending</span>')}
                                    <span class="text-gray-400 text-xs" x-text="open ? '‚ñ≤' : '‚ñº'"></span>
                                </div>
                            </div>
                            <div x-show="open" x-cloak class="border-t px-4 py-3 bg-gray-50 text-sm space-y-3">
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div><span class="text-gray-500">Review Link:</span> <a href="${t.review_link}" target="_blank" class="text-bitcoin hover:underline break-all">${t.review_link}</a></div>
                                    <div><span class="text-gray-500">Raffle Block:</span> ${t.raffle_block}</div>
                                </div>
                                ${t.review_text ? '<div><span class="text-gray-500">Review Text:</span><div class="mt-1 p-2 bg-white rounded border text-gray-700">' + t.review_text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div></div>' : '<div class="text-gray-400 italic">No review text submitted</div>'}
                                ${t.validation_reason ? '<div><span class="text-gray-500">Validation Reason:</span> ' + t.validation_reason + '</div>' : ''}
                                <div class="flex gap-2 pt-2">
                                    ${!t.is_valid ? '<button @click.stop="approveTicket(' + t.id + ')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-medium hover:bg-green-600">‚úì Approve</button>' : ''}
                                    ${t.is_valid || !t.validation_reason ? '<button @click.stop="rejectTicket(' + t.id + ')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-medium hover:bg-red-600">‚úó Reject</button>' : ''}
                                    ${t.review_text ? '<button @click.stop="aiLoading=true; aiCheckTicket(' + t.id + ').then(r => { aiResult=r; aiLoading=false; })" :disabled="aiLoading" class="bg-purple-500 text-white px-3 py-1 rounded text-xs font-medium hover:bg-purple-600 disabled:opacity-50"><span x-text="aiLoading ? \'Checking...\' : \'ü§ñ AI Check\'"></span></button>' : ''}
                                </div>
                                <div x-show="aiResult" x-cloak class="p-2 rounded text-xs" :class="aiResult && aiResult.isValid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                    <span class="font-bold" x-text="aiResult && aiResult.isValid ? 'AI: Valid ‚úì' : 'AI: Invalid ‚úó'"></span>
                                    <span x-text="aiResult ? ' ‚Äî ' + aiResult.reason : ''"></span>
                                </div>
                            </div>
                        </div>
                        `).join('') : 
                        '<div class="text-center text-gray-500 py-8">No tickets yet</div>'
                    }
                </div>
            </div>
            
            <!-- Users Tab -->
            <div x-show="activeTab === 'users'" x-cloak class="p-6">
                <h3 class="font-bold mb-4">Registered Users</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">ID</th>
                                <th class="text-left py-2">Email</th>
                                <th class="text-left py-2">LNURL</th>
                                <th class="text-left py-2">Active</th>
                                <th class="text-left py-2">Registered</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${typeof users !== 'undefined' && users.length > 0 ? 
                                users.slice(0, 50).map(u => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-2">${u.id}</td>
                                    <td class="py-2">${u.email}</td>
                                    <td class="py-2 max-w-xs truncate">${u.lnurl_address}</td>
                                    <td class="py-2">${u.is_active ? '<span class="text-green-500">‚úì</span>' : '<span class="text-red-500">‚úó</span>'}</td>
                                    <td class="py-2">${new Date(u.created_at).toLocaleDateString()}</td>
                                </tr>
                                `).join('') : 
                                '<tr><td colspan="5" class="py-4 text-center text-gray-500">No users yet</td></tr>'
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Raffles Tab -->
            <div x-show="activeTab === 'raffles'" x-cloak class="p-6">
                <h3 class="font-bold mb-4">Raffle History</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">Block</th>
                                <th class="text-left py-2">Tickets</th>
                                <th class="text-left py-2">Winner</th>
                                <th class="text-left py-2">Prize</th>
                                <th class="text-left py-2">Paid</th>
                                <th class="text-left py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${typeof raffles !== 'undefined' && raffles.length > 0 ? 
                                raffles.map(r => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-2">#${r.block_height.toLocaleString()}</td>
                                    <td class="py-2">${r.total_tickets}</td>
                                    <td class="py-2">${r.email || '-'}</td>
                                    <td class="py-2">${r.prize_amount_sats ? r.prize_amount_sats.toLocaleString() + ' sats' : '-'}</td>
                                    <td class="py-2">${r.claim_status === 'claimed' || r.paid_at ? '<span class="text-green-500">‚úì Claimed</span>' : r.claim_status === 'expired' ? '<span class="text-gray-500">‚è∞ Expired</span>' : '<span class="text-yellow-500">‚è≥ Awaiting</span>'}</td>
                                    <td class="py-2 space-x-2">
                                        ${r.claim_token ? '<a href="/claim/' + r.claim_token + '" target="_blank" class="text-bitcoin hover:underline text-xs">üîó Claim Link</a>' : ''}
                                        ${!r.paid_at ? `
                                        <button 
                                            @click="markPaid(${r.id})"
                                            class="text-bitcoin hover:underline text-xs"
                                        >
                                            Mark Paid
                                        </button>
                                        ` : '<span class="text-green-500 text-xs">Done</span>'}
                                        <button 
                                            @click="deleteRaffle(${r.id}, ${r.prize_amount_sats || 0})"
                                            class="text-red-500 hover:underline text-xs ml-2"
                                            title="Delete this raffle record"
                                        >
                                            üóëÔ∏è Delete
                                        </button>
                                    </td>
                                </tr>
                                `).join('') : 
                                '<tr><td colspan="6" class="py-4 text-center text-gray-500">No raffles yet</td></tr>'
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function adminDashboard() {
    return {
        activeTab: 'tickets',
        raffleBlockHeight: '',
        prizeAmount: '',
        raffleLoading: false,
        raffleResult: null,
        raffleSuccess: false,
        password: '${typeof password !== 'undefined' ? password : ''}',
        
        async runRaffle() {
            if (!this.raffleBlockHeight) {
                alert('Please enter a block height');
                return;
            }
            
            this.raffleLoading = true;
            this.raffleResult = null;
            
            try {
                const response = await fetch('/api/admin/raffle/run', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Password': this.password
                    },
                    body: JSON.stringify({
                        blockHeight: parseInt(this.raffleBlockHeight),
                        prizeAmountSats: this.prizeAmount ? parseInt(this.prizeAmount) : null
                    })
                });
                
                const data = await response.json();
                this.raffleResult = data;
                this.raffleSuccess = data.success;
                
                if (data.success) {
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                this.raffleResult = { error: error.message };
                this.raffleSuccess = false;
            }
            
            this.raffleLoading = false;
        },
        
        async payWinner(raffleId, amountSats) {
            const amount = amountSats || prompt('Enter amount in sats:');
            if (!amount) return;
            if (!confirm('Pay ' + amount + ' sats via Lightning?')) return;
            
            try {
                const response = await fetch('/api/admin/raffle/' + raffleId + '/pay', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Password': this.password
                    },
                    body: JSON.stringify({ amountSats: parseInt(amount) })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Payment sent! Hash: ' + data.payment.paymentHash);
                    location.reload();
                } else {
                    alert('Payment failed: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        },
        
        async markPaid(raffleId) {
            if (!confirm('Mark this raffle as paid?')) return;
            
            try {
                const response = await fetch('/api/admin/raffle/' + raffleId + '/mark-paid', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Password': this.password
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        },
        
        async approveTicket(ticketId) {
            try {
                const response = await fetch('/api/admin/tickets/' + ticketId + '/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': this.password },
                    body: JSON.stringify({ isValid: true, reason: 'Manually approved by admin' })
                });
                const data = await response.json();
                if (data.success) location.reload();
                else alert(data.error);
            } catch (error) { alert('Error: ' + error.message); }
        },
        
        async rejectTicket(ticketId) {
            const reason = prompt('Rejection reason (optional):') || 'Manually rejected by admin';
            try {
                const response = await fetch('/api/admin/tickets/' + ticketId + '/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': this.password },
                    body: JSON.stringify({ isValid: false, reason })
                });
                const data = await response.json();
                if (data.success) location.reload();
                else alert(data.error);
            } catch (error) { alert('Error: ' + error.message); }
        },
        
        async deleteRaffle(raffleId, prizeSats) {
            var refund = false;
            if (prizeSats > 0) {
                refund = confirm('Delete raffle #' + raffleId + '?\\n\\nClick OK to also refund ' + prizeSats + ' sats to the raffle fund.\\nClick Cancel to delete without refund.');
                if (!confirm('Are you sure you want to delete this raffle record?')) return;
            } else {
                if (!confirm('Delete raffle #' + raffleId + '? This cannot be undone.')) return;
            }
            
            try {
                const response = await fetch('/api/admin/raffle/' + raffleId, {
                    method: 'DELETE',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Password': this.password
                    },
                    body: JSON.stringify({ refund: refund })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        },
        
        async aiCheckTicket(ticketId) {
            try {
                const response = await fetch('/api/admin/tickets/' + ticketId + '/ai-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': this.password }
                });
                const data = await response.json();
                if (data.success) return data.validation;
                else { alert(data.error); return null; }
            } catch (error) { alert('Error: ' + error.message); return null; }
        }
    }
}

function telegramPanel(pw) {
    return {
        allChats: [],
        primaryChat: '',
        newChatId: '',
        chatsLoading: true,
        telegramLoading: false,
        telegramMsg: '',
        telegramOk: true,
        inviteLink: '',
        copied: false,
        init() {
            fetch('/api/admin/telegram/chats', { headers: { 'X-Admin-Password': pw } })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        this.allChats = d.chats.all || [];
                        this.primaryChat = d.chats.primary || '';
                    }
                    this.chatsLoading = false;
                })
                .catch(() => { this.chatsLoading = false; });
        },
        async addChat() {
            const id = this.newChatId.trim();
            if (!id) return;
            this.telegramLoading = true;
            this.telegramMsg = '';
            try {
                const r = await fetch('/api/admin/telegram/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': pw },
                    body: JSON.stringify({ chatId: id })
                });
                const d = await r.json();
                if (d.success) {
                    this.telegramOk = true;
                    this.telegramMsg = '‚úÖ Added! A test message was sent to that chat.';
                    this.newChatId = '';
                    if (!this.allChats.includes(id)) this.allChats.push(id);
                } else {
                    this.telegramOk = false;
                    this.telegramMsg = '‚ùå ' + d.error;
                }
            } catch(e) {
                this.telegramOk = false;
                this.telegramMsg = '‚ùå Error: ' + e.message;
            }
            this.telegramLoading = false;
        },
        async removeChat(chatId) {
            if (!confirm('Remove chat ID ' + chatId + '?')) return;
            try {
                const r = await fetch('/api/admin/telegram/chats/' + chatId, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': pw }
                });
                const d = await r.json();
                if (d.success) {
                    this.allChats = this.allChats.filter(c => c !== chatId);
                    this.telegramOk = true;
                    this.telegramMsg = 'Removed.';
                    setTimeout(() => this.telegramMsg = '', 2000);
                } else {
                    this.telegramOk = false;
                    this.telegramMsg = '‚ùå ' + d.error;
                }
            } catch(e) {
                this.telegramOk = false;
                this.telegramMsg = '‚ùå Error: ' + e.message;
            }
        },
        async generateInvite() {
            this.telegramLoading = true;
            this.inviteLink = '';
            this.copied = false;
            try {
                const r = await fetch('/api/admin/telegram/invite', {
                    method: 'POST',
                    headers: { 'X-Admin-Password': pw }
                });
                const d = await r.json();
                if (d.success) {
                    this.inviteLink = d.inviteLink;
                } else {
                    this.telegramOk = false;
                    this.telegramMsg = '‚ùå ' + d.error;
                }
            } catch(e) {
                this.telegramOk = false;
                this.telegramMsg = '‚ùå Error: ' + e.message;
            }
            this.telegramLoading = false;
        },
        async copyInvite() {
            try {
                await navigator.clipboard.writeText(this.inviteLink);
                this.copied = true;
                setTimeout(() => this.copied = false, 2000);
            } catch(e) {
                // Fallback: select the input
                this.telegramMsg = 'Copy manually from the field above';
            }
        }
    }
}

function settingsPanel(pw) {
    return {
        reviewMode: 'manual_review',
        reviewLinkMode: 'google',
        autoPayMode: 'false',
        settingsMsg: '',
        init() {
            fetch('/api/admin/settings', { headers: { 'X-Admin-Password': pw } })
                .then(r => r.json())
                .then(d => {
                    if (d.success && d.settings) {
                        this.reviewMode = d.settings.review_mode || 'manual_review';
                        this.reviewLinkMode = d.settings.review_link_mode || 'google';
                        this.autoPayMode = d.settings.raffle_auto_trigger || 'false';
                    }
                })
                .catch(() => {});
        },
        async saveSettings() {
            this.settingsMsg = '';
            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': pw },
                    body: JSON.stringify({ settings: { review_mode: this.reviewMode, review_link_mode: this.reviewLinkMode, raffle_auto_trigger: this.autoPayMode } })
                });
                const data = await response.json();
                if (data.success) this.settingsMsg = 'Settings saved!';
                else this.settingsMsg = 'Error: ' + data.error;
                setTimeout(() => this.settingsMsg = '', 3000);
            } catch (error) { this.settingsMsg = 'Error: ' + error.message; }
        }
    }
}

// Global functions for the unpaid raffle alert buttons
function payUnpaidRaffle(raffleId, amountSats) {
    var pw = '${typeof password !== "undefined" ? password : ""}';
    var amount = amountSats || prompt('Enter amount in sats:');
    if (!amount) return;
    if (!confirm('Pay ' + amount + ' sats via Lightning?')) return;
    
    fetch('/api/admin/raffle/' + raffleId + '/pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Password': pw },
        body: JSON.stringify({ amountSats: parseInt(amount) })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            alert('Payment sent! Hash: ' + data.payment.paymentHash);
            location.reload();
        } else {
            alert('Payment failed: ' + data.error);
        }
    })
    .catch(function(err) { alert('Error: ' + err.message); });
}

function markUnpaidRafflePaid(raffleId) {
    var pw = '${typeof password !== "undefined" ? password : ""}';
    if (!confirm('Mark this raffle as paid?')) return;
    
    fetch('/api/admin/raffle/' + raffleId + '/mark-paid', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Password': pw }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) location.reload();
        else alert(data.error);
    })
    .catch(function(err) { alert('Error: ' + err.message); });
}
</script>
` }) %>
