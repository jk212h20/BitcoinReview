<%- include('layout', { body: `

<section class="max-w-2xl mx-auto px-4 py-12" x-data="submitReviewForm()">
    
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Submit a Review</h1>
        <p class="text-gray-600">Reviewed a Bitcoin-accepting merchant in Roatan? Submit your review link to enter the raffle!</p>
    </div>

    <!-- Raffle Info -->
    ${typeof raffleInfo !== 'undefined' && raffleInfo ? `
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-8 text-center">
        <p class="text-sm text-gray-700">
            ‚è∞ Next raffle at block <strong class="bitcoin-orange">${raffleInfo.nextRaffleBlock.toLocaleString()}</strong>
            ${raffleInfo.blocksUntilNext ? `‚Äî ~${raffleInfo.timeEstimate} away` : ''}
        </p>
    </div>
    ` : ''}

    <!-- Success Message -->
    <div x-show="success" x-cloak class="bg-green-50 border border-green-300 rounded-lg p-8 mb-6 text-center">
        <div class="text-4xl mb-4">üéâ</div>
        <p class="text-green-800 text-lg font-medium" x-text="successMessage"></p>
        <button @click="resetForm()" class="mt-6 bg-bitcoin text-white px-6 py-2 rounded-lg font-bold hover:bg-bitcoin-dark transition">Submit another review</button>
    </div>

    <!-- Error Message -->
    <div x-show="error" x-cloak class="bg-red-50 border border-red-300 rounded-lg p-4 mb-6">
        <p class="text-red-700" x-text="error"></p>
    </div>

    <!-- Form -->
    <form x-show="!success" @submit.prevent="doSubmit" class="bg-white rounded-xl shadow-md p-6 space-y-5">

        <!-- Merchant (required, searchable dropdown) -->
        <div x-data="merchantSearch(${JSON.stringify(typeof merchants !== 'undefined' ? merchants : [])})" class="relative">
            <label class="block text-sm font-semibold text-gray-700 mb-1">
                üè™ Which merchant did you review? <span class="text-red-500">*</span>
            </label>
            <input
                type="text"
                x-model="query"
                @input="onInput()"
                @focus="open = true"
                @blur="onBlur()"
                @keydown.arrow-down.prevent="moveDown()"
                @keydown.arrow-up.prevent="moveUp()"
                @keydown.enter.prevent="selectHighlighted()"
                @keydown.escape="open = false; query = selected || ''"
                :class="selected ? 'border-green-400 bg-green-50' : 'border-gray-300'"
                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
                placeholder="Type to search merchants..."
                autocomplete="off"
            >
            <!-- Dropdown -->
            <div x-show="open && filtered.length > 0" x-cloak
                class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-56 overflow-y-auto">
                <template x-for="(m, i) in filtered" :key="m.id">
                    <div
                        @mousedown.prevent="selectMerchant(m)"
                        :class="i === highlighted ? 'bg-bitcoin text-white' : 'hover:bg-orange-50'"
                        class="px-4 py-2 cursor-pointer text-sm flex items-center gap-2"
                    >
                        <span x-text="m.name"></span>
                        <span class="ml-auto text-xs opacity-60" x-text="[m.lightning ? '‚ö°' : '', m.onchain ? '‚Çø' : ''].filter(Boolean).join(' ')"></span>
                    </div>
                </template>
            </div>
            <p class="text-xs text-gray-500 mt-1">
                Only merchants on the <a href="/merchants" target="_blank" class="text-bitcoin hover:underline">Roatan Bitcoin map</a> are eligible.
            </p>
            <!-- Hidden input to sync selected merchant name back to parent Alpine scope -->
            <input type="hidden" x-model="selected" @change="$dispatch('merchant-selected', { name: selected })">
            <div x-show="selected" x-cloak class="mt-1 text-xs text-green-600 font-medium">‚úì Selected: <span x-text="selected"></span></div>
        </div>
        
        <!-- Review Link (required) -->
        <div>
            <label for="reviewLink" class="block text-sm font-semibold text-gray-700 mb-1">
                üîó Review Link <span class="text-red-500">*</span>
            </label>
            <input 
                type="url" 
                id="reviewLink" 
                x-model="reviewLink"
                required
                placeholder="https://maps.app.goo.gl/..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">Paste the link to your review (Google Maps, Yelp, TripAdvisor, etc.)</p>
        </div>

        <!-- Review Text (optional) -->
        <div>
            <label for="reviewText" class="block text-sm font-semibold text-gray-700 mb-1">
                üìù Review Text <span class="text-gray-400 font-normal">(optional but speeds up approval)</span>
            </label>
            <textarea 
                id="reviewText" 
                x-model="reviewText"
                rows="4"
                placeholder="Paste the text of your review here..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            ></textarea>
        </div>

        <!-- Lightning Address (required) -->
        <div>
            <label for="lnurl" class="block text-sm font-semibold text-gray-700 mb-1">
                ‚ö° Lightning Address <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="lnurl" 
                x-model="lnurl"
                required
                placeholder="you@walletofsatoshi.com"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">Your Lightning address so we can send prizes if you win</p>
        </div>

        <!-- Email (required) -->
        <div>
            <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">
                üìß Email <span class="text-red-500">*</span>
            </label>
            <input 
                type="email" 
                id="email" 
                x-model="email"
                required
                placeholder="you@example.com"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">So we can notify you if you win the raffle</p>
        </div>

        <!-- Submit Button -->
        <button 
            type="submit" 
            :disabled="loading || !reviewLink.trim() || !lnurl.trim() || !email.trim() || !merchantName.trim()"
            class="w-full bg-bitcoin hover:bg-bitcoin-dark text-white font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <span x-show="!loading">Submit Review</span>
            <span x-show="loading" x-cloak>Submitting...</span>
        </button>
    </form>

    <!-- How to get a review link -->
    <div x-show="!success" class="mt-8 bg-gray-50 rounded-xl p-6">
        <h3 class="font-bold text-lg mb-3">üìã How to submit</h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700 text-sm">
            <li>Visit a Bitcoin-accepting merchant in Roatan (<a href="/merchants" class="text-bitcoin hover:underline">see the list</a>)</li>
            <li>Leave a review on Google Maps, Yelp, TripAdvisor, etc. mentioning your Bitcoin experience</li>
            <li>Copy the link to your review and paste it above</li>
            <li>Select the merchant from the dropdown, fill in your details, and submit!</li>
        </ol>
    </div>
</section>

<script>
function merchantSearch(merchants) {
    return {
        merchants,
        query: '',
        selected: '',
        open: false,
        highlighted: -1,
        get filtered() {
            if (!this.query.trim()) return this.merchants.slice(0, 8);
            const q = this.query.toLowerCase();
            return this.merchants.filter(m => m.name.toLowerCase().includes(q)).slice(0, 8);
        },
        onInput() {
            this.open = true;
            this.highlighted = -1;
            // If user typed something that doesn't match selected, clear selection
            if (this.selected && this.query !== this.selected) {
                this.selected = '';
                this.$dispatch('merchant-cleared');
            }
        },
        onBlur() {
            // Delay so mousedown on option fires first
            setTimeout(() => {
                this.open = false;
                // If nothing selected, restore or clear
                if (!this.selected) this.query = '';
            }, 150);
        },
        selectMerchant(m) {
            this.selected = m.name;
            this.query = m.name;
            this.open = false;
            this.highlighted = -1;
            // Propagate to parent
            this.$nextTick(() => {
                this.$el.querySelector('input[type=hidden]').dispatchEvent(new Event('change'));
            });
        },
        moveDown() {
            if (this.filtered.length === 0) return;
            this.highlighted = (this.highlighted + 1) % this.filtered.length;
        },
        moveUp() {
            if (this.filtered.length === 0) return;
            this.highlighted = this.highlighted <= 0 ? this.filtered.length - 1 : this.highlighted - 1;
        },
        selectHighlighted() {
            if (this.highlighted >= 0 && this.filtered[this.highlighted]) {
                this.selectMerchant(this.filtered[this.highlighted]);
            }
        }
    };
}

function submitReviewForm() {
    return {
        reviewLink: '',
        reviewText: '',
        merchantName: '',
        email: localStorage.getItem('br_email') || '',
        lnurl: localStorage.getItem('br_lnurl') || '',
        loading: false,
        success: false,
        successMessage: '',
        error: '',

        init() {
            // Listen for merchant selection from nested Alpine component
            this.$el.addEventListener('merchant-selected', (e) => {
                this.merchantName = e.detail.name || '';
            });
            this.$el.addEventListener('merchant-cleared', () => {
                this.merchantName = '';
            });
            // Also watch the hidden input directly as fallback
            const observer = new MutationObserver(() => {
                const hidden = this.$el.querySelector('input[type=hidden]');
                if (hidden) this.merchantName = hidden.value || '';
            });
            observer.observe(this.$el, { subtree: true, attributes: true, attributeFilter: ['value'] });
        },
        
        async doSubmit() {
            this.loading = true;
            this.error = '';
            this.success = false;

            // Re-read merchantName from hidden input as final check
            const hiddenInput = this.$el.querySelector('input[type=hidden]');
            if (hiddenInput && hiddenInput.value) this.merchantName = hiddenInput.value;
            
            if (!this.merchantName.trim()) {
                this.error = 'Please select which merchant you reviewed from the dropdown';
                this.loading = false;
                return;
            }
            
            if (!this.reviewLink.trim()) {
                this.error = 'Please paste your review link';
                this.loading = false;
                return;
            }
            
            if (!this.email.trim()) {
                this.error = 'Please provide your email address';
                this.loading = false;
                return;
            }
            
            if (!this.lnurl.trim()) {
                this.error = 'Please provide your Lightning address';
                this.loading = false;
                return;
            }
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewLink: this.reviewLink.trim(),
                        reviewText: this.reviewText.trim() || null,
                        merchantName: this.merchantName.trim(),
                        email: this.email.trim() || null,
                        lnurl: this.lnurl.trim() || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.success = true;
                    this.successMessage = data.message;
                    
                    if (this.email.trim()) localStorage.setItem('br_email', this.email.trim());
                    if (this.lnurl.trim()) localStorage.setItem('br_lnurl', this.lnurl.trim());
                } else {
                    this.error = data.error || 'Something went wrong';
                }
            } catch (err) {
                this.error = 'Network error. Please try again.';
            } finally {
                this.loading = false;
            }
        },
        
        resetForm() {
            this.success = false;
            this.successMessage = '';
            this.error = '';
            this.reviewLink = '';
            this.reviewText = '';
            this.merchantName = '';
        }
    };
}
</script>

`, donationAddress: typeof donationAddress !== 'undefined' ? donationAddress : 'Coming soon' }) %>
