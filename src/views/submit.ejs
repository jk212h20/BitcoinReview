<%- include('layout', { body: `

<section class="max-w-2xl mx-auto px-4 py-12" x-data="submitReviewForm()">
    
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Submit a Review</h1>
        <p class="text-gray-600">Reviewed a Bitcoin-accepting merchant in Roatan? Submit your Google review link to enter the raffle!</p>
    </div>

    <!-- Raffle Info -->
    ${typeof raffleInfo !== 'undefined' && raffleInfo ? `
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-8 text-center">
        <p class="text-sm text-gray-700">
            ‚è∞ Next raffle at block <strong class="bitcoin-orange">${raffleInfo.nextRaffleBlock.toLocaleString()}</strong>
            ${raffleInfo.blocksUntilNext ? `‚Äî ~${raffleInfo.timeEstimate} away` : ''}
        </p>
    </div>
    ` : ''}

    <!-- Success Message -->
    <div x-show="success" x-cloak class="bg-green-50 border border-green-300 rounded-lg p-8 mb-6 text-center">
        <div class="text-4xl mb-4">üéâ</div>
        <p class="text-green-800 text-lg font-medium" x-text="successMessage"></p>
        <button @click="resetForm()" class="mt-6 bg-bitcoin text-white px-6 py-2 rounded-lg font-bold hover:bg-bitcoin-dark transition">Submit another review</button>
    </div>

    <!-- Error Message -->
    <div x-show="error" x-cloak class="bg-red-50 border border-red-300 rounded-lg p-4 mb-6">
        <p class="text-red-700" x-text="error"></p>
    </div>

    <!-- Form -->
    <form x-show="!success" @submit.prevent="doSubmit" class="bg-white rounded-xl shadow-md p-6 space-y-5">
        
        <!-- Review Link (required) -->
        <div>
            <label for="reviewLink" class="block text-sm font-semibold text-gray-700 mb-1">
                üîó Google Review Link <span class="text-red-500">*</span>
            </label>
            <input 
                type="url" 
                id="reviewLink" 
                x-model="reviewLink"
                required
                placeholder="https://maps.app.goo.gl/..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">Paste the link to your Google review of a Bitcoin merchant</p>
        </div>

        <!-- Review Text (optional) -->
        <div>
            <label for="reviewText" class="block text-sm font-semibold text-gray-700 mb-1">
                üìù Review Text <span class="text-gray-400 font-normal">(optional)</span>
            </label>
            <textarea 
                id="reviewText" 
                x-model="reviewText"
                rows="4"
                placeholder="Paste the text of your review here (helps us verify faster)..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">Copy-paste your review text so we can verify it mentions Bitcoin. This speeds up approval!</p>
        </div>

        <!-- Lightning Address (required) -->
        <div>
            <label for="lnurl" class="block text-sm font-semibold text-gray-700 mb-1">
                ‚ö° Lightning Address <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="lnurl" 
                x-model="lnurl"
                required
                placeholder="you@walletofsatoshi.com"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">Your Lightning address so we can send prizes if you win</p>
        </div>

        <!-- Email (required) -->
        <div>
            <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">
                üìß Email <span class="text-red-500">*</span>
            </label>
            <input 
                type="email" 
                id="email" 
                x-model="email"
                required
                placeholder="you@example.com"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">So we can notify you if you win the raffle</p>
        </div>

        <!-- Submit Button -->
        <button 
            type="submit" 
            :disabled="loading || !reviewLink.trim() || !lnurl.trim() || !email.trim()"
            class="w-full bg-bitcoin hover:bg-bitcoin-dark text-white font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <span x-show="!loading">Submit Review</span>
            <span x-show="loading" x-cloak>Submitting...</span>
        </button>
    </form>

    <!-- How to get a review link -->
    <div x-show="!success" class="mt-8 bg-gray-50 rounded-xl p-6">
        <h3 class="font-bold text-lg mb-3">üìã How to get your Google review link</h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700 text-sm">
            <li>Visit a Bitcoin-accepting merchant in Roatan (<a href="/merchants" class="text-bitcoin hover:underline">see the list</a>)</li>
            <li>Leave a review on their Google Maps listing mentioning your Bitcoin experience</li>
            <li>Click the 3 dots on your review ‚Üí "Share review" ‚Üí copy the link</li>
            <li>Paste it above and submit!</li>
        </ol>
    </div>
</section>

<script>
function submitReviewForm() {
    return {
        reviewLink: '',
        reviewText: '',
        email: localStorage.getItem('br_email') || '',
        lnurl: localStorage.getItem('br_lnurl') || '',
        loading: false,
        success: false,
        successMessage: '',
        error: '',
        
        async doSubmit() {
            this.loading = true;
            this.error = '';
            this.success = false;
            
            if (!this.reviewLink.trim()) {
                this.error = 'Please paste your Google review link';
                this.loading = false;
                return;
            }
            
            if (!this.email.trim()) {
                this.error = 'Please provide your email address';
                this.loading = false;
                return;
            }
            
            if (!this.lnurl.trim()) {
                this.error = 'Please provide your Lightning address';
                this.loading = false;
                return;
            }
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewLink: this.reviewLink.trim(),
                        reviewText: this.reviewText.trim() || null,
                        email: this.email.trim() || null,
                        lnurl: this.lnurl.trim() || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.success = true;
                    this.successMessage = data.message;
                    
                    // Save email and lnurl to localStorage for next time
                    if (this.email.trim()) {
                        localStorage.setItem('br_email', this.email.trim());
                    }
                    if (this.lnurl.trim()) {
                        localStorage.setItem('br_lnurl', this.lnurl.trim());
                    }
                } else {
                    this.error = data.error || 'Something went wrong';
                }
            } catch (err) {
                this.error = 'Network error. Please try again.';
            } finally {
                this.loading = false;
            }
        },
        
        resetForm() {
            this.success = false;
            this.successMessage = '';
            this.error = '';
            this.reviewLink = '';
            this.reviewText = '';
            // Keep email and lnurl from localStorage
        }
    };
}
</script>

`, donationAddress: typeof donationAddress !== 'undefined' ? donationAddress : 'Coming soon' }) %>
