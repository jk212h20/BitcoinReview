<%
const merchantsJson = JSON.stringify(typeof merchants !== 'undefined' ? merchants : []);
%>
<%- include('layout', { body: `

<section class="max-w-2xl mx-auto px-4 py-12" x-data="submitReviewForm()">
    
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Submit a Review</h1>
        <p class="text-gray-600">Reviewed a Bitcoin-accepting merchant in Roatan? Submit your review link to enter the raffle!</p>
    </div>

    <!-- Raffle Info -->
    ${typeof raffleInfo !== 'undefined' && raffleInfo ? `
    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-8 text-center">
        <p class="text-sm text-gray-700">
            ‚è∞ Next raffle at block <strong class="bitcoin-orange">${raffleInfo.nextRaffleBlock.toLocaleString()}</strong>
            ${raffleInfo.blocksUntilNext ? \`‚Äî ~\${raffleInfo.timeEstimate} away\` : ''}
        </p>
    </div>
    ` : ''}

    <!-- Success Message -->
    <div x-show="success" x-cloak class="bg-green-50 border border-green-300 rounded-lg p-8 mb-6 text-center">
        <div class="text-4xl mb-4">üéâ</div>
        <p class="text-green-800 text-lg font-medium" x-text="successMessage"></p>
        <button @click="resetForm()" class="mt-6 bg-bitcoin text-white px-6 py-2 rounded-lg font-bold hover:bg-bitcoin-dark transition">Submit another review</button>
    </div>

    <!-- Error Message -->
    <div x-show="error" x-cloak class="bg-red-50 border border-red-300 rounded-lg p-4 mb-6">
        <p class="text-red-700" x-text="error"></p>
    </div>

    <!-- Form -->
    <form x-show="!success" @submit.prevent="doSubmit" class="bg-white rounded-xl shadow-md p-6 space-y-5">

        <!-- Merchant searchable dropdown (required) -->
        <div id="merchant-picker" class="relative">
            <label class="block text-sm font-semibold text-gray-700 mb-1">
                üè™ Which merchant did you review? <span class="text-red-500">*</span>
            </label>
            <input
                type="text"
                id="merchant-input"
                oninput="merchantFilter(this.value)"
                onfocus="merchantFilter(this.value)"
                onblur="merchantBlur()"
                onkeydown="merchantKeydown(event)"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
                placeholder="Type to search merchants..."
                autocomplete="off"
            >
            <div id="merchant-dropdown"
                class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-56 overflow-y-auto">
            </div>
            <p class="text-xs text-gray-500 mt-1">
                Only merchants on the <a href="/merchants" target="_blank" class="text-bitcoin hover:underline">Roatan Bitcoin map</a> are eligible.
            </p>
            <div id="merchant-selected-label" class="hidden mt-1 text-xs text-green-600 font-medium"></div>
        </div>
        
        <!-- Review Link (required) -->
        <div>
            <label for="reviewLink" class="block text-sm font-semibold text-gray-700 mb-1">
                üîó Review Link <span class="text-red-500">*</span>
            </label>
            <input 
                type="url" 
                id="reviewLink" 
                x-model="reviewLink"
                required
                placeholder="https://maps.app.goo.gl/..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">Paste the link to your review (Google Maps, Yelp, TripAdvisor, etc.)</p>
        </div>

        <!-- Review Text (optional) -->
        <div>
            <label for="reviewText" class="block text-sm font-semibold text-gray-700 mb-1">
                üìù Review Text <span class="text-gray-400 font-normal">(optional but speeds up approval)</span>
            </label>
            <textarea 
                id="reviewText" 
                x-model="reviewText"
                rows="4"
                placeholder="Paste the text of your review here..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            ></textarea>
        </div>

        <!-- Lightning Address (required) -->
        <div>
            <label for="lnurl" class="block text-sm font-semibold text-gray-700 mb-1">
                ‚ö° Lightning Address <span class="text-red-500">*</span>
            </label>
            <input 
                type="text" 
                id="lnurl" 
                x-model="lnurl"
                required
                placeholder="you@walletofsatoshi.com"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">Your Lightning address so we can send prizes if you win</p>
        </div>

        <!-- Email (required) -->
        <div>
            <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">
                üìß Email <span class="text-red-500">*</span>
            </label>
            <input 
                type="email" 
                id="email" 
                x-model="email"
                required
                placeholder="you@example.com"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
            >
            <p class="text-xs text-gray-500 mt-1">So we can notify you if you win the raffle</p>
        </div>

        <!-- Submit Button -->
        <button 
            type="submit" 
            :disabled="loading || !reviewLink.trim() || !lnurl.trim() || !email.trim() || !merchantName.trim()"
            class="w-full bg-bitcoin hover:bg-bitcoin-dark text-white font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <span x-show="!loading">Submit Review</span>
            <span x-show="loading" x-cloak>Submitting...</span>
        </button>
    </form>

    <!-- How to submit -->
    <div x-show="!success" class="mt-8 bg-gray-50 rounded-xl p-6">
        <h3 class="font-bold text-lg mb-3">üìã How to submit</h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700 text-sm">
            <li>Visit a Bitcoin-accepting merchant in Roatan (<a href="/merchants" class="text-bitcoin hover:underline">see the list</a>)</li>
            <li>Leave a review on Google Maps, Yelp, TripAdvisor, etc. mentioning your Bitcoin experience</li>
            <li>Copy the link to your review and paste it above</li>
            <li>Select the merchant from the dropdown, fill in your details, and submit!</li>
        </ol>
    </div>
</section>

<script>
// ----- Merchant search (vanilla JS, no Alpine nesting issues) -----
var _merchants = ` + merchantsJson + `;
var _highlighted = -1;
var _filtered = [];

function merchantFilter(q) {
    var dropdown = document.getElementById('merchant-dropdown');
    q = (q || '').toLowerCase().trim();
    _filtered = q
        ? _merchants.filter(function(m) { return m.name.toLowerCase().includes(q); })
        : _merchants.slice(0, 8);
    _highlighted = -1;
    renderDropdown(dropdown);
    dropdown.classList.toggle('hidden', _filtered.length === 0);
}

function renderDropdown(dropdown) {
    dropdown.innerHTML = '';
    _filtered.forEach(function(m, i) {
        var el = document.createElement('div');
        el.className = 'px-4 py-2 cursor-pointer text-sm flex items-center gap-2 hover:bg-orange-50';
        el.dataset.idx = i;
        el.innerHTML = '<span>' + escHtml(m.name) + '</span>' +
            '<span class="ml-auto text-xs opacity-60">' +
            (m.lightning ? '‚ö°' : '') + (m.onchain ? ' ‚Çø' : '') + '</span>';
        el.addEventListener('mousedown', function(e) {
            e.preventDefault();
            pickMerchant(m.name);
        });
        dropdown.appendChild(el);
    });
    highlightRow();
}

function highlightRow() {
    var dropdown = document.getElementById('merchant-dropdown');
    Array.from(dropdown.children).forEach(function(el, i) {
        el.className = i === _highlighted
            ? 'px-4 py-2 cursor-pointer text-sm flex items-center gap-2 bg-bitcoin text-white'
            : 'px-4 py-2 cursor-pointer text-sm flex items-center gap-2 hover:bg-orange-50';
    });
}

function pickMerchant(name) {
    document.getElementById('merchant-input').value = name;
    document.getElementById('merchant-input').classList.add('border-green-400', 'bg-green-50');
    document.getElementById('merchant-input').classList.remove('border-gray-300');
    var lbl = document.getElementById('merchant-selected-label');
    lbl.textContent = '‚úì Selected: ' + name;
    lbl.classList.remove('hidden');
    document.getElementById('merchant-dropdown').classList.add('hidden');
    // Pass to Alpine
    var alpine = document.querySelector('[x-data="submitReviewForm()"]');
    if (alpine && alpine._x_dataStack) {
        alpine._x_dataStack[0].merchantName = name;
    } else {
        // Fallback: set via Alpine.$data
        try { Alpine.$data(alpine).merchantName = name; } catch(e) {}
    }
}

function merchantBlur() {
    setTimeout(function() {
        document.getElementById('merchant-dropdown').classList.add('hidden');
    }, 150);
}

function merchantKeydown(e) {
    var dropdown = document.getElementById('merchant-dropdown');
    if (dropdown.classList.contains('hidden')) {
        if (e.key === 'ArrowDown') { merchantFilter(e.target.value); return; }
        return;
    }
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        _highlighted = (_highlighted + 1) % _filtered.length;
        highlightRow();
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        _highlighted = _highlighted <= 0 ? _filtered.length - 1 : _highlighted - 1;
        highlightRow();
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (_highlighted >= 0 && _filtered[_highlighted]) pickMerchant(_filtered[_highlighted].name);
    } else if (e.key === 'Escape') {
        dropdown.classList.add('hidden');
    }
}

function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ----- Alpine submit form -----
function submitReviewForm() {
    return {
        reviewLink: '',
        reviewText: '',
        merchantName: '',
        email: localStorage.getItem('br_email') || '',
        lnurl: localStorage.getItem('br_lnurl') || '',
        loading: false,
        success: false,
        successMessage: '',
        error: '',

        init() {
            // Expose Alpine instance so vanilla merchantSearch can write to it
            var self = this;
            document.getElementById('merchant-input').addEventListener('input', function() {
                // Clear selection if user changes text
                if (self.merchantName && this.value !== self.merchantName) {
                    self.merchantName = '';
                    document.getElementById('merchant-selected-label').classList.add('hidden');
                    this.classList.remove('border-green-400', 'bg-green-50');
                    this.classList.add('border-gray-300');
                }
            });
            window._setMerchantName = function(name) { self.merchantName = name; };
        },

        async doSubmit() {
            this.loading = true;
            this.error = '';
            this.success = false;

            // Final check: read from input field if Alpine state empty
            if (!this.merchantName.trim()) {
                var inp = document.getElementById('merchant-input');
                if (inp && inp.value.trim()) this.merchantName = inp.value.trim();
            }

            if (!this.merchantName.trim()) {
                this.error = 'Please select which merchant you reviewed from the dropdown';
                this.loading = false;
                return;
            }

            if (!this.reviewLink.trim()) {
                this.error = 'Please paste your review link';
                this.loading = false;
                return;
            }

            if (!this.email.trim()) {
                this.error = 'Please provide your email address';
                this.loading = false;
                return;
            }

            if (!this.lnurl.trim()) {
                this.error = 'Please provide your Lightning address';
                this.loading = false;
                return;
            }

            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewLink: this.reviewLink.trim(),
                        reviewText: this.reviewText.trim() || null,
                        merchantName: this.merchantName.trim(),
                        email: this.email.trim() || null,
                        lnurl: this.lnurl.trim() || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.success = true;
                    this.successMessage = data.message;
                    if (this.email.trim()) localStorage.setItem('br_email', this.email.trim());
                    if (this.lnurl.trim()) localStorage.setItem('br_lnurl', this.lnurl.trim());
                } else {
                    this.error = data.error || 'Something went wrong';
                }
            } catch (err) {
                this.error = 'Network error. Please try again.';
            } finally {
                this.loading = false;
            }
        },

        resetForm() {
            this.success = false;
            this.successMessage = '';
            this.error = '';
            this.reviewLink = '';
            this.reviewText = '';
            this.merchantName = '';
            document.getElementById('merchant-input').value = '';
            document.getElementById('merchant-selected-label').classList.add('hidden');
            document.getElementById('merchant-input').classList.remove('border-green-400', 'bg-green-50');
            document.getElementById('merchant-input').classList.add('border-gray-300');
        }
    };
}

// Wire up pickMerchant to Alpine after page load
document.addEventListener('DOMContentLoaded', function() {
    var origPick = pickMerchant;
    pickMerchant = function(name) {
        origPick(name);
        if (window._setMerchantName) window._setMerchantName(name);
    };
});
</script>

`, donationAddress: typeof donationAddress !== 'undefined' ? donationAddress : 'Coming soon' }) %>
