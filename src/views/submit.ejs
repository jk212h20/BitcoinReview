<%
var merchantsJson = JSON.stringify(typeof merchants !== 'undefined' ? merchants : []);
var raffleBlock = typeof raffleInfo !== 'undefined' && raffleInfo ? raffleInfo.nextRaffleBlock.toLocaleString() : null;
var timeEst = typeof raffleInfo !== 'undefined' && raffleInfo && raffleInfo.blocksUntilNext ? ('~' + raffleInfo.timeEstimate + ' away') : null;
%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Review - Bitcoin Review Raffle</title>
    <link href="/styles.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center space-x-2">
                    <span class="text-2xl">‚Çø</span>
                    <span class="font-bold text-xl">Bitcoin Review Raffle</span>
                </a>
                <div class="hidden md:flex space-x-6">
                    <a href="/" class="text-gray-600 hover:text-bitcoin">Home</a>
                    <a href="/submit" class="text-gray-600 hover:text-bitcoin font-semibold text-bitcoin">Submit Review</a>
                    <a href="/reviews" class="text-gray-600 hover:text-bitcoin">Reviews</a>
                    <a href="/merchants" class="text-gray-600 hover:text-bitcoin">Merchants</a>
                    <a href="/how-it-works" class="text-gray-600 hover:text-bitcoin">How It Works</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                <a href="/" class="block py-2 text-gray-600 hover:text-bitcoin">Home</a>
                <a href="/submit" class="block py-2 text-gray-600 hover:text-bitcoin">Submit Review</a>
                <a href="/reviews" class="block py-2 text-gray-600 hover:text-bitcoin">Reviews</a>
                <a href="/merchants" class="block py-2 text-gray-600 hover:text-bitcoin">Merchants</a>
                <a href="/how-it-works" class="block py-2 text-gray-600 hover:text-bitcoin">How It Works</a>
            </div>
        </div>
    </nav>

    <main>
    <section class="max-w-2xl mx-auto px-4 py-12" x-data="submitReviewForm()">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">Submit a Review</h1>
            <p class="text-gray-600">Reviewed a Bitcoin-accepting merchant in Roatan? Submit your review link to enter the raffle!</p>
        </div>

        <!-- Raffle Info -->
        <% if (raffleBlock) { %>
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-8 text-center">
            <p class="text-sm text-gray-700">
                Next raffle at block <strong class="bitcoin-orange"><%= raffleBlock %></strong>
                <% if (timeEst) { %> ‚Äî <%= timeEst %><% } %>
            </p>
        </div>
        <% } %>

        <!-- Success Message -->
        <div x-show="success" x-cloak class="bg-green-50 border border-green-300 rounded-lg p-8 mb-6 text-center">
            <div class="text-4xl mb-4">üéâ</div>
            <p class="text-green-800 text-lg font-medium" x-text="successMessage"></p>
            <button @click="resetForm()" class="mt-6 bg-bitcoin text-white px-6 py-2 rounded-lg font-bold hover:bg-bitcoin-dark transition">Submit another review</button>
        </div>

        <!-- Error Message -->
        <div x-show="error" x-cloak class="bg-red-50 border border-red-300 rounded-lg p-4 mb-6">
            <p class="text-red-700" x-text="error"></p>
        </div>

        <!-- Form -->
        <form x-show="!success" @submit.prevent="doSubmit" class="bg-white rounded-xl shadow-md p-6 space-y-5">

            <!-- Merchant searchable dropdown (required) -->
            <div id="merchant-picker" class="relative">
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                    üè™ Which merchant did you review? <span class="text-red-500">*</span>
                </label>
                <input
                    type="text"
                    id="merchant-input"
                    oninput="merchantFilter(this.value)"
                    onfocus="merchantFilter(this.value)"
                    onblur="merchantBlur()"
                    onkeydown="merchantKeydown(event)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
                    placeholder="Type to search merchants..."
                    autocomplete="off"
                >
                <div id="merchant-dropdown"
                    class="hidden absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-56 overflow-y-auto">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    Only merchants on the <a href="/merchants" target="_blank" class="text-bitcoin hover:underline">Roatan Bitcoin map</a> are eligible.
                </p>
                <div id="merchant-selected-label" class="hidden mt-1 text-xs text-green-600 font-medium"></div>
            </div>

            <!-- Review Link (required) -->
            <div>
                <label for="reviewLink" class="block text-sm font-semibold text-gray-700 mb-1">
                    üîó Review Link <span class="text-red-500">*</span>
                </label>
                <input
                    type="url"
                    id="reviewLink"
                    x-model="reviewLink"
                    required
                    placeholder="https://maps.app.goo.gl/..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
                >
                <p class="text-xs text-gray-500 mt-1">Paste the share link to your review (Google Maps, Yelp, TripAdvisor, etc.)</p>
            </div>

            <!-- Bitcoin Experience Questions -->
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 space-y-4">
                <div class="text-sm font-semibold text-gray-700 mb-1">‚Çø Bitcoin Experience <span class="text-red-500">*</span></div>
                
                <div>
                    <p class="text-sm text-gray-700 mb-2">Did you try to use Bitcoin at this merchant?</p>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="triedBitcoin" value="yes" x-model="triedBitcoin"
                                class="w-4 h-4 text-bitcoin focus:ring-bitcoin">
                            <span class="text-sm">Yes</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="triedBitcoin" value="no" x-model="triedBitcoin"
                                class="w-4 h-4 text-bitcoin focus:ring-bitcoin">
                            <span class="text-sm">No</span>
                        </label>
                    </div>
                </div>

                <div>
                    <p class="text-sm text-gray-700 mb-2">Did the merchant accept Bitcoin?</p>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="merchantAccepted" value="yes" x-model="merchantAccepted"
                                class="w-4 h-4 text-bitcoin focus:ring-bitcoin">
                            <span class="text-sm">Yes</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="merchantAccepted" value="no" x-model="merchantAccepted"
                                class="w-4 h-4 text-bitcoin focus:ring-bitcoin">
                            <span class="text-sm">No</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="merchantAccepted" value="na" x-model="merchantAccepted"
                                class="w-4 h-4 text-bitcoin focus:ring-bitcoin">
                            <span class="text-sm">N/A (didn't try)</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Lightning Address (required) -->
            <div>
                <label for="lnurl" class="block text-sm font-semibold text-gray-700 mb-1">
                    ‚ö° Lightning Address <span class="text-red-500">*</span>
                </label>
                <input
                    type="text"
                    id="lnurl"
                    x-model="lnurl"
                    required
                    placeholder="you@walletofsatoshi.com"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
                >
                <p class="text-xs text-gray-500 mt-1">Your Lightning address so we can send prizes if you win.</p>
                <div class="mt-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-gray-600">
                    <p class="font-medium text-gray-700 mb-1">üí° Don't have a Lightning address?</p>
                    <p>Download <a href="https://phoenix.acinq.co/" target="_blank" class="text-bitcoin font-semibold hover:underline">Phoenix Wallet</a> ‚Äî it's the easiest way to get one.</p>
                    <p class="mt-1">Once installed, go to <strong>Settings ‚Üí Experimental features</strong> to find your Lightning address. It looks like:</p>
                    <code class="block mt-1 bg-white border border-gray-200 rounded px-2 py-1 text-gray-800 font-mono">somethingUnique@phoenixwallet.me</code>
                </div>
            </div>

            <!-- Email (required) -->
            <div>
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">
                    üìß Email <span class="text-red-500">*</span>
                </label>
                <input
                    type="email"
                    id="email"
                    x-model="email"
                    required
                    placeholder="you@example.com"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-bitcoin outline-none transition"
                >
                <p class="text-xs text-gray-500 mt-1">So we can notify you if you win the raffle</p>
            </div>

            <!-- Submit Button -->
            <button
                type="submit"
                :disabled="loading || !reviewLink.trim() || !lnurl.trim() || !email.trim() || !merchantName.trim()"
                class="w-full bg-bitcoin hover:bg-bitcoin-dark text-white font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <span x-show="!loading">Submit Review</span>
                <span x-show="loading" x-cloak>Submitting...</span>
            </button>
        </form>

        <!-- How to submit -->
        <div x-show="!success" class="mt-8 bg-gray-50 rounded-xl p-6">
            <h3 class="font-bold text-lg mb-3">üìã How to submit</h3>
            <ol class="list-decimal list-inside space-y-2 text-gray-700 text-sm">
                <li>Visit a Bitcoin-accepting merchant in Roatan (<a href="/merchants" class="text-bitcoin hover:underline">see the list</a>)</li>
                <li>Leave a review on Google Maps, Yelp, TripAdvisor, etc. mentioning your Bitcoin experience</li>
                <li>Copy the link to your review and paste it above</li>
                <li>Select the merchant from the dropdown, fill in your details, and submit!</li>
            </ol>
        </div>
    </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h3 class="font-bold text-lg mb-4">Bitcoin Review Raffle</h3>
                    <p class="text-gray-400">Incentivizing Bitcoin adoption in Roatan through community reviews.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Quick Links</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="/submit" class="hover:text-white">Submit a Review</a></li>
                        <li><a href="/merchants" class="hover:text-white">Find Merchants</a></li>
                        <li><a href="/how-it-works" class="hover:text-white">How It Works</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Support the Raffle</h3>
                    <p class="text-gray-400 text-sm mb-2">Donate to fund prizes:</p>
                    <% const addr = typeof donationAddress !== 'undefined' ? donationAddress : ''; %>
                    <% if (addr && addr !== 'Not configured' && addr !== 'Coming soon') { %>
                    <div x-data="{ showQR: false }" class="relative">
                        <a href="https://mempool.space/address/<%= addr %>"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-xs bg-gray-700 px-2 py-1 rounded break-all text-bitcoin hover:text-yellow-400 transition inline-block"
                           @mouseenter="showQR = true"
                           @mouseleave="showQR = false">
                            <%= addr %>
                        </a>
                        <div x-show="showQR"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 scale-100"
                             x-transition:leave-end="opacity-0 scale-95"
                             class="absolute bottom-full mb-2 left-0 bg-white p-3 rounded-lg shadow-xl z-50"
                             @mouseenter="showQR = true"
                             @mouseleave="showQR = false">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=bitcoin:<%= addr %>"
                                 alt="Bitcoin QR Code"
                                 width="160"
                                 height="160"
                                 class="rounded">
                            <p class="text-gray-600 text-xs text-center mt-1">Scan to donate</p>
                        </div>
                        <button @click="navigator.clipboard.writeText('<%= addr %>'); $el.textContent = '‚úì Copied!'; setTimeout(() => $el.textContent = 'üìã Copy', 2000)"
                                class="text-xs text-gray-500 hover:text-gray-300 mt-1 block transition">
                            üìã Copy
                        </button>
                    </div>
                    <% } else { %>
                    <code class="text-xs bg-gray-700 px-2 py-1 rounded break-all">Not configured</code>
                    <% } %>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>üå¥ Made with ‚ö° in Roatan</p>
            </div>
        </div>
    </footer>

    <script>
        document.getElementById('mobile-menu-btn')?.addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    </script>

    <script>
    // ----- Merchant search (vanilla JS) -----
    var _merchants = <%- merchantsJson %>;
    var _highlighted = -1;
    var _filtered = [];

    function merchantFilter(q) {
        var dropdown = document.getElementById('merchant-dropdown');
        q = (q || '').toLowerCase().trim();
        _filtered = q
            ? _merchants.filter(function(m) { return m.name.toLowerCase().includes(q); })
            : _merchants.slice(0, 8);
        _highlighted = -1;
        renderDropdown(dropdown);
        dropdown.classList.toggle('hidden', _filtered.length === 0);
    }

    function renderDropdown(dropdown) {
        dropdown.innerHTML = '';
        _filtered.forEach(function(m, i) {
            var el = document.createElement('div');
            el.className = 'px-4 py-2 cursor-pointer text-sm flex items-center gap-2 hover:bg-orange-50';
            el.innerHTML = '<span>' + escHtml(m.name) + '</span>' +
                '<span class="ml-auto text-xs opacity-60">' +
                (m.lightning ? '‚ö°' : '') + (m.onchain ? ' ‚Çø' : '') + '</span>';
            el.addEventListener('mousedown', function(e) {
                e.preventDefault();
                pickMerchant(m.name);
            });
            dropdown.appendChild(el);
        });
        highlightRow();
    }

    function highlightRow() {
        var dropdown = document.getElementById('merchant-dropdown');
        Array.from(dropdown.children).forEach(function(el, i) {
            el.className = i === _highlighted
                ? 'px-4 py-2 cursor-pointer text-sm flex items-center gap-2 bg-bitcoin text-white'
                : 'px-4 py-2 cursor-pointer text-sm flex items-center gap-2 hover:bg-orange-50';
        });
    }

    function pickMerchant(name) {
        var inp = document.getElementById('merchant-input');
        inp.value = name;
        inp.classList.add('border-green-400', 'bg-green-50');
        inp.classList.remove('border-gray-300');
        var lbl = document.getElementById('merchant-selected-label');
        lbl.textContent = '‚úì Selected: ' + name;
        lbl.classList.remove('hidden');
        document.getElementById('merchant-dropdown').classList.add('hidden');
        if (window._setMerchantName) window._setMerchantName(name);
    }

    function merchantBlur() {
        setTimeout(function() {
            document.getElementById('merchant-dropdown').classList.add('hidden');
        }, 150);
    }

    function merchantKeydown(e) {
        var dropdown = document.getElementById('merchant-dropdown');
        if (dropdown.classList.contains('hidden')) {
            if (e.key === 'ArrowDown') { merchantFilter(e.target.value); return; }
            return;
        }
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            _highlighted = (_highlighted + 1) % _filtered.length;
            highlightRow();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            _highlighted = _highlighted <= 0 ? _filtered.length - 1 : _highlighted - 1;
            highlightRow();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (_highlighted >= 0 && _filtered[_highlighted]) pickMerchant(_filtered[_highlighted].name);
        } else if (e.key === 'Escape') {
            dropdown.classList.add('hidden');
        }
    }

    function escHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ----- Alpine submit form -----
    function submitReviewForm() {
        return {
            reviewLink: '',
            reviewText: '',
            merchantName: '',
            triedBitcoin: '',
            merchantAccepted: '',
            email: localStorage.getItem('br_email') || '',
            lnurl: localStorage.getItem('br_lnurl') || '',
            loading: false,
            success: false,
            successMessage: '',
            error: '',

            init() {
                var self = this;
                window._setMerchantName = function(name) { self.merchantName = name; };
                // Clear merchant if user edits the input after selection
                document.getElementById('merchant-input').addEventListener('input', function() {
                    if (self.merchantName && this.value !== self.merchantName) {
                        self.merchantName = '';
                        document.getElementById('merchant-selected-label').classList.add('hidden');
                        this.classList.remove('border-green-400', 'bg-green-50');
                        this.classList.add('border-gray-300');
                    }
                });
            },

            async doSubmit() {
                this.loading = true;
                this.error = '';
                this.success = false;

                if (!this.merchantName.trim()) {
                    this.error = 'Please select which merchant you reviewed from the dropdown';
                    this.loading = false;
                    return;
                }
                if (!this.reviewLink.trim()) {
                    this.error = 'Please paste your review link';
                    this.loading = false;
                    return;
                }
                if (!this.email.trim()) {
                    this.error = 'Please provide your email address';
                    this.loading = false;
                    return;
                }
                if (!this.lnurl.trim()) {
                    this.error = 'Please provide your Lightning address';
                    this.loading = false;
                    return;
                }
                if (!this.triedBitcoin) {
                    this.error = 'Please answer: Did you try to use Bitcoin?';
                    this.loading = false;
                    return;
                }
                if (!this.merchantAccepted) {
                    this.error = 'Please answer: Did the merchant accept Bitcoin?';
                    this.loading = false;
                    return;
                }

                try {
                    const response = await fetch('/api/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reviewLink: this.reviewLink.trim(),
                            reviewText: this.reviewText.trim() || null,
                            merchantName: this.merchantName.trim(),
                            email: this.email.trim(),
                            lnurl: this.lnurl.trim(),
                            triedBitcoin: this.triedBitcoin === 'yes',
                            merchantAccepted: this.merchantAccepted === 'yes'
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.success = true;
                        this.successMessage = data.message;
                        if (this.email.trim()) localStorage.setItem('br_email', this.email.trim());
                        if (this.lnurl.trim()) localStorage.setItem('br_lnurl', this.lnurl.trim());
                    } else {
                        this.error = data.error || 'Something went wrong';
                    }
                } catch (err) {
                    this.error = 'Network error. Please try again.';
                } finally {
                    this.loading = false;
                }
            },

            resetForm() {
                this.success = false;
                this.successMessage = '';
                this.error = '';
                this.reviewLink = '';
                this.reviewText = '';
                this.merchantName = '';
                this.triedBitcoin = '';
                this.merchantAccepted = '';
                var inp = document.getElementById('merchant-input');
                if (inp) {
                    inp.value = '';
                    inp.classList.remove('border-green-400', 'bg-green-50');
                    inp.classList.add('border-gray-300');
                }
                var lbl = document.getElementById('merchant-selected-label');
                if (lbl) lbl.classList.add('hidden');
            }
        };
    }
    </script>
</body>
</html>
